以太坊P2P原理与实现

1. 以太坊中，去中心化依赖P2P

   1. 底层路由表：封装kad路由，节点数据结构，计算，节点搜索，验证等基本功能
   2. 中间peer抽象：对外提供peer检测，初始化，事件订阅，状态查询，启动停止等
   3. 上层：在中间层启动peer的时候获取peer，对它进行维护

2. Kad算法

   1. 概念：一种分布式存储及路由的算法

   2. 功能：文件存储及查找

   3. 以去中心化图书馆为例

      1. 前提：没有中心化图书馆，所有的书（文件）分派到每一个学生手上，每个学生都是一个分布式节点

      2. 问题

         1. 每个节点上存储哪些文件，如何处理这些文件的增加删除
         2. 怎么去找到这个文件

      3. Kad算法解决方式

         1. 节点的基本要素
            1. NODE ID：二进制，长160位
            2. 节点的IP地，端口号
         2. 节点维护的内容
            1. 需要存储的文件 ID
            2. 其它部分节点的IP地址和端口号
            3. 在kad中，路由表被叫做k-bucket，按照node id进行分层
         3. 文件存储与查找
            1. 存储需要考虑两个问题
               1. 所有文件能够比较均衡的分配到每一个节点中
               2. 如果要进行查找，查找方式不能太复杂
               3. 在存储文件时，将该文件存放在与文件名哈希值域相同的所有节点中（不能只放在一个节点上面）
         4. 文件查找
            1. 节点间的距离
            2. 按照距离进行分层
            3. 定位
               1. 计算要查找的文件哈希
               2. 查找ID为此哈希的节点或邻近节点
               3. 如果能够直接在自己的节点列表中找到，就返回，否则随机找一个距离减半的节点进行查找
            4. Kad算法相关指令
               1. Ping：测试一个节点是否在线
               2. Store：要求一个节点存储一份数据
               3. Find_node：根据节点ID查找一个节点
               4. Find_value：根据key值查找数据，与find_node类似

      4. 源码分析

         主要包：p2p、p2p/discover，入口：p2p/server.go -> Start()

         1. database.go：封装node数据库相关操作

         2. node.go：节点数据结构

         3. ntp.go：同步时间

         4. table.go：路由表

         5. udp：网络操作

      5. 启动P2P服务流程

      6. 中间层：在p2p中，中间层不断的从路由中提取节点，加入到peer中，对peer进行维护，如果一直没有人使用这个peer，就删除，删除是因为这样可以平均使用所有的节点，而不是仅仅依赖特定的几个节点。

      7. 上层：（eth.peer）主要就是对底层(p2p.peer)节点的维护和调用

           
      
           
      
           
